const oe="modulepreload",se=function(d){return"/pontus-hultgren-site/"+d},X={},ce=function(g,M,V){let I=Promise.resolve();if(M&&M.length>0){let s=function(m){return Promise.all(m.map(t=>Promise.resolve(t).then(p=>({status:"fulfilled",value:p}),p=>({status:"rejected",reason:p}))))};document.getElementsByTagName("link");const l=document.querySelector("meta[property=csp-nonce]"),P=l?.nonce||l?.getAttribute("nonce");I=s(M.map(m=>{if(m=se(m),m in X)return;X[m]=!0;const t=m.endsWith(".css"),p=t?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${m}"]${p}`))return;const v=document.createElement("link");if(v.rel=t?"stylesheet":oe,t||(v.as="script"),v.crossOrigin="",v.href=m,P&&v.setAttribute("nonce",P),document.head.appendChild(v),t)return new Promise((B,k)=>{v.addEventListener("load",B),v.addEventListener("error",()=>k(new Error(`Unable to preload CSS for ${m}`)))})}))}function f(s){const l=new Event("vite:preloadError",{cancelable:!0});if(l.payload=s,window.dispatchEvent(l),!l.defaultPrevented)throw s}return I.then(s=>{for(const l of s||[])l.status==="rejected"&&f(l.reason);return g().catch(f)})};document.addEventListener("DOMContentLoaded",function(){var d=document.getElementById("piano-container"),g=document.getElementById("piano-toggle"),M=document.getElementById("piano-minimize"),V=document.getElementById("piano-keyboard"),I=document.getElementById("midi-upload"),f=document.getElementById("midi-play"),s=document.getElementById("midi-stop"),l=document.getElementById("midi-name"),P=document.getElementById("piano-volume"),m=document.querySelector(".volume-value");if(!V){console.error("Piano keyboard element not found");return}var t=null,p=null,v=null,B=!1,k=[],x=.7,Z=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],R=1,ee=7,te=36,j={a:0,w:1,s:2,e:3,d:4,f:5,t:6,g:7,y:8,h:9,u:10,j:11,k:12,o:13,l:14,p:15};function ae(){V.innerHTML="";for(var e=[],n=[],a=R;a<R+ee;a++)for(var r=0;r<12;r++){var h=Z[r],E=h.includes("#"),L=(a+1)*12+r,u=document.createElement("div");if(u.className="piano-key "+(E?"black":"white"),u.setAttribute("data-note",L.toString()),u.setAttribute("data-note-name",h+a),E)n.push({key:u,midiNote:L,afterWhiteIndex:e.length-1});else{if(h==="C"){var A=document.createElement("span");A.className="key-label",A.textContent="C"+a,u.appendChild(A)}e.push({key:u,midiNote:L})}(function(i,c){i.addEventListener("mousedown",function(o){o.preventDefault(),D(c),i.classList.add("active")}),i.addEventListener("mouseup",function(){S(c),i.classList.remove("active")}),i.addEventListener("mouseleave",function(){S(c),i.classList.remove("active")}),i.addEventListener("touchstart",function(o){o.preventDefault(),D(c),i.classList.add("active")},{passive:!1}),i.addEventListener("touchend",function(){S(c),i.classList.remove("active")})})(u,L)}e.forEach(function(i){V.appendChild(i.key)}),n.forEach(function(i){var c=(i.afterWhiteIndex+1)*te;i.key.style.left=c+"px",V.appendChild(i.key)}),console.log("Piano created:",e.length,"white keys,",n.length,"black keys")}var _=null,y=null;function K(){if(!t){var e=window.AudioContext||window.webkitAudioContext;t=new e,y=t.createDynamicsCompressor(),y.threshold.setValueAtTime(-24,t.currentTime),y.knee.setValueAtTime(30,t.currentTime),y.ratio.setValueAtTime(12,t.currentTime),y.attack.setValueAtTime(.003,t.currentTime),y.release.setValueAtTime(.25,t.currentTime),y.connect(t.destination),_=t.createConvolver();for(var n=2,a=t.sampleRate,r=a*n,h=t.createBuffer(2,r,a),E=0;E<2;E++)for(var L=h.getChannelData(E),u=0;u<r;u++)L[u]=(Math.random()*2-1)*Math.pow(1-u/r,2.5);_.buffer=h;var A=t.createGain();A.gain.setValueAtTime(.15,t.currentTime),_.connect(A),A.connect(y),p={activeNotes:new Map,reverbGain:A,play:function(i){if(t){var c=440*Math.pow(2,(i-69)/12),o=t.currentTime,T=[],W=[],G=t.createGain(),re=[{mult:1,amp:1,type:"sine"},{mult:2,amp:.5,type:"sine"},{mult:3,amp:.25,type:"sine"},{mult:4,amp:.125,type:"sine"},{mult:5,amp:.0625,type:"sine"},{mult:6,amp:.03,type:"sine"}],Y=Math.max(.3,1-(i-40)/80);re.forEach(function(F,J){var C=t.createOscillator(),w=t.createGain();C.type=F.type,C.frequency.setValueAtTime(c*F.mult,o),J>0&&C.detune.setValueAtTime((Math.random()-.5)*4,o);var H=F.amp*Y*Math.pow(.85,J);w.gain.setValueAtTime(0,o),w.gain.linearRampToValueAtTime(H*x*.3,o+.002),w.gain.exponentialRampToValueAtTime(H*x*.15,o+.1),w.gain.exponentialRampToValueAtTime(H*x*.05,o+.5),w.gain.exponentialRampToValueAtTime(1e-4,o+3),C.connect(w),w.connect(G),C.start(o),C.stop(o+4),T.push(C),W.push(w)});var b=t.createBiquadFilter();b.type="lowpass";var Q=Math.min(8e3,800+c*4)*Y;b.frequency.setValueAtTime(Q*2,o),b.frequency.exponentialRampToValueAtTime(Q*.5,o+.5),b.Q.setValueAtTime(1,o);var q=t.createBiquadFilter();q.type="highpass",q.frequency.setValueAtTime(Math.max(20,c*.5),o),G.gain.setValueAtTime(1,o),G.connect(b),b.connect(q),q.connect(y),q.connect(_),this.activeNotes.set(i,{oscillators:T,gains:W,masterGain:G,filter:b})}},stop:function(i){if(t){var c=this.activeNotes.get(i);if(c){var o=t.currentTime;c.gains.forEach(function(T){T.gain.cancelScheduledValues(o),T.gain.setValueAtTime(T.gain.value,o),T.gain.exponentialRampToValueAtTime(1e-4,o+.15)}),setTimeout(function(){c.oscillators.forEach(function(T){try{T.stop()}catch{}})},200),this.activeNotes.delete(i)}}}}}}var N=document.querySelectorAll(".viz-bar");function ne(){for(var e=2+Math.floor(Math.random()*4),n=0;n<e;n++){var a=N[Math.floor(Math.random()*N.length)];a.classList.add("active"),setTimeout((function(r){return function(){r.classList.remove("active")}})(a),150)}}function D(e){K(),p&&p.play(e),ne()}function S(e){p&&p.stop(e)}function O(e,n){var a=V.querySelector('[data-note="'+e+'"]');a&&(n?a.classList.add("active","midi-active"):a.classList.remove("active","midi-active"))}I&&I.addEventListener("change",function(e){var n=e.target.files&&e.target.files[0];n&&n.arrayBuffer().then(function(a){return ce(()=>import("./Midi.gen2fKUB.js").then(r=>r.M),[]).then(function(r){var h=r.Midi;v=new h(a),l&&(l.textContent=n.name),f&&f.classList.remove("hidden"),s&&s.classList.add("hidden"),$()})}).catch(function(a){console.error("Error loading MIDI:",a),l&&(l.textContent="Error loading file")})});function $(){if(!(!v||B)){K(),B=!0,f&&f.classList.add("hidden"),s&&s.classList.remove("hidden"),v.tracks.forEach(function(a){a.notes.forEach(function(r){var h=r.time*1e3,E=(r.time+r.duration)*1e3,L=window.setTimeout(function(){D(r.midi),O(r.midi,!0)},h),u=window.setTimeout(function(){S(r.midi),O(r.midi,!1)},E);k.push(L,u)})});var e=v.duration*1e3,n=window.setTimeout(z,e+500);k.push(n)}}f&&f.addEventListener("click",$),s&&s.addEventListener("click",z);function z(){B=!1,k.forEach(function(e){clearTimeout(e)}),k=[],document.querySelectorAll(".piano-key.active").forEach(function(e){var n=parseInt(e.dataset.note||"0");S(n),e.classList.remove("active","midi-active")}),f&&f.classList.remove("hidden"),s&&s.classList.add("hidden")}P&&P.addEventListener("input",function(e){x=parseInt(e.target.value)/100,m&&(m.textContent=Math.round(x*100)+"%")});var ie=localStorage.getItem("piano-visible");ie==="false"&&(d&&d.classList.remove("visible"),g&&g.classList.remove("active")),g&&g.addEventListener("click",function(){K(),d&&d.classList.toggle("visible"),g.classList.toggle("active");var e=d&&d.classList.contains("visible");localStorage.setItem("piano-visible",e?"true":"false")}),M&&M.addEventListener("click",function(){d&&d.classList.remove("visible"),g&&g.classList.remove("active"),localStorage.setItem("piano-visible","false"),z()});var U=new Set;document.addEventListener("keydown",function(e){if(!(!d||!d.classList.contains("visible"))&&!(e.target instanceof HTMLInputElement)&&!(e.repeat||U.has(e.key.toLowerCase()))){var n=j[e.key.toLowerCase()];if(n!==void 0){U.add(e.key.toLowerCase());var a=(R+2)*12+n;D(a),O(a,!0)}}}),document.addEventListener("keyup",function(e){var n=j[e.key.toLowerCase()];if(n!==void 0){U.delete(e.key.toLowerCase());var a=(R+2)*12+n;S(a),O(a,!1)}}),ae()});
